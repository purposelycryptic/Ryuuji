<!DOCTYPE html>
<html>

	<head>
		<title id="plexSeries-summary">Ryuuji</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="refresh" content="120">
		<link rel="stylesheet" href="web/style.css">
		<link rel="stylesheet" href="web/bootstrap.min.css">
		<link rel="shortcut icon" href="web/favicon.ico">
		<link rel="mask-icon" href="web/favicon-mask.svg" color="#cc7b19">
	</head>
	
	<body>
		<div class="container-fluid">
			<div class="row h-100">
				<div class="col-4 mx-auto plexTile-background plexTile-align">
					<img id="plexSeries-thumbnail" src="web/ryuuji.gif" alt="Ryuuji Loading Animation">
					<div class="plexTile-content">
						<h2 id="plexSeries-title"><p class="ryuujiLoading">Searching for activity<span>.</span><span>.</span><span>.</span></p></h2>
						<h3 id="plexSeries-status"></h3>
						<p id="plexSeries-episode"></p>
						<p id="plexSeries-synopsis"></p> 
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="web/bootstrap.min.js"></script>
	<script>
			var succ = false;
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				myFunction(this);
			}
		};
		setInterval(function() {
			xhttp.open("GET", "http://[IP_ADDRESS]:[PLEX_PORT]/status/sessions/?X-Plex-Token=[X_PLEX_TOKEN]", true);
			xhttp.send();
		}, 5000);

		function myFunction(xml) {
			var xmlDoc = xml.responseXML;
			var x = xmlDoc.getElementsByTagName('Video');
			for (i = 0; i < x.length; i++) {
				var z = x[i].childNodes[8];
				console.log(z);
				var token = "/?X-Plex-Token=[X_PLEX_TOKEN]"
				var series = x[i].getAttributeNode("grandparentTitle");
				var episode = x[i].getAttributeNode("index");
				var season = x[i].getAttributeNode("parentIndex");
				var name = x[i].getAttributeNode("title");
				var sum = x[i].getAttributeNode("summary");
				var thumbnail = x[i].getAttributeNode("thumb");
				var y = x[i].getElementsByTagName('Player');
				for (j = 0; j < y.length; j++) {
					var state = y[j].getAttributeNode("state");
					var playerIP = y[j].getAttributeNode("remotePublicAddress")
				}
				var player = "http://[IP_ADDRESS]:[PLEX_PORT]";
				var thumbloc = player + thumbnail.nodeValue + ".png" + token;
				
				document.getElementById("plexSeries-summary").innerHTML = series.nodeValue + " &#8226; " + "S" + season.nodeValue + "E" + episode.nodeValue + " &#8226; " + "Currently " + state.nodeValue;
				document.getElementById("plexSeries-title").innerHTML = series.nodeValue + "<span style=\"float:right;text-transform:capitalize;color:hsla(0,0%,100%,.45);font-size:1.5rem;\">" + state.nodeValue + "</span>";
				document.getElementById("plexSeries-episode").innerHTML = "S" + season.nodeValue + " &#8226; " + "E" + episode.nodeValue + " &#9473; " + name.nodeValue;
				document.getElementById("plexSeries-thumbnail").src = thumbloc;
				document.getElementById("plexSeries-synopsis").innerHTML = "<span style=\"font-weight:bold;color:#ffffff;\">" + "Synopsis" + "</span>" + "</br>" + "<span style=\"color:hsla(0,0%,100%,.45);\">" + sum.nodeValue + "</span>";

			}
		}
	</script>
</html>